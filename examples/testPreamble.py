

from gnuradio import gr
from gnuradio import eng_notation
from gnuradio.eng_option import eng_option
from optparse import OptionParser
import gnuradio.ieee802_11 as gr_ieee802_11

fft_preamble = (0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j,-0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j, -0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j,0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j,-0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j, -0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j,-0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j, -0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j,-0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j, -0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j,-0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j, 0.3680 + 0.3680j, -1.0596 + 0.0187j, -0.1078 - 0.6282j, 1.1421 - 0.1012j, 0.7360, 1.1421 - 0.1012j, -0.1078 - 0.6282j, -1.0596 + 0.0187j, 0.3680 + 0.3680j, 0.0187 - 1.0596j, -0.6282 - 0.1078j, -0.1012 + 1.1421j, 0 + 0.7360j, -0.1012 + 1.1421j, -0.6282 - 0.1078j, 0.0187 - 1.0596j,-1.2500, 0.0983 - 0.7808j, 0.7337 - 0.8470j, -0.7351 - 0.9210j, -0.0224 - 0.4302j, 0.6006 + 0.5923j, -1.0186 + 0.1640j, -0.9751 + 0.1325j, -0.2803 + 1.2071j, -0.4516 + 0.1744j, -0.4825 - 0.6503j, 0.5565 - 0.1130j, 0.6577 - 0.7389j, -1.0501 - 0.5218j, -0.4577 - 0.3144j, 0.2953 - 0.7868j, 0.5000 + 0.5000j, 0.9539 + 0.0328j, -0.1799 - 1.2853j, 0.4694 + 0.1195j, 0.1958 + 0.4683j, -1.0944 + 0.3790j, 0.0079 + 0.9200j,  0.4267 - 0.0326j, 0.7803 + 0.2071j, -0.3065 + 0.8494j, -0.9210 + 0.4414j, 0.4786 + 0.7017j, 0.1689 - 0.2231j, 0.7747 - 0.6624j, 0.3180 + 0.8893j, -0.0410 + 0.9626j, 1.2500, -0.0410 - 0.9626j, 0.3180 - 0.8893j, 0.7747 + 0.6624j, 0.1689 + 0.2231j, 0.4786 - 0.7017j, -0.9210 - 0.4414j, -0.3065 - 0.8494j, 0.7803 - 0.2071j, 0.4267 + 0.0326j, 0.0079 - 0.9200j, -1.0944 - 0.3790j, 0.1958 - 0.4683j, 0.4694 - 0.1195j, -0.1799 + 1.2853j, 0.9539 - 0.0328j, 0.5000 - 0.5000j, 0.2953 + 0.7868j, -0.4577 + 0.3144j, -1.0501 + 0.5218j, 0.6577 + 0.7389j, 0.5565 + 0.1130j, -0.4825 + 0.6503j, -0.4516 - 0.1744j, -0.2803 - 1.2071j, -0.9751 - 0.1325j, -1.0186 - 0.1640j, 0.6006 - 0.5923j, -0.0224 + 0.4302j, -0.7351 + 0.9210j, 0.7337 + 0.8470j, 0.0983 + 0.7808j,-1.2500, 0.0983 - 0.7808j, 0.7337 - 0.8470j, -0.7351 - 0.9210j, -0.0224 - 0.4302j, 0.6006 + 0.5923j, -1.0186 + 0.1640j, -0.9751 + 0.1325j, -0.2803 + 1.2071j, -0.4516 + 0.1744j, -0.4825 - 0.6503j, 0.5565 - 0.1130j, 0.6577 - 0.7389j, -1.0501 - 0.5218j, -0.4577 - 0.3144j, 0.2953 - 0.7868j, 0.5000 + 0.5000j, 0.9539 + 0.0328j, -0.1799 - 1.2853j, 0.4694 + 0.1195j, 0.1958 + 0.4683j, -1.0944 + 0.3790j, 0.0079 + 0.9200j,  0.4267 - 0.0326j, 0.7803 + 0.2071j, -0.3065 + 0.8494j, -0.9210 + 0.4414j, 0.4786 + 0.7017j, 0.1689 - 0.2231j, 0.7747 - 0.6624j, 0.3180 + 0.8893j, -0.0410 + 0.9626j, 1.2500, -0.0410 - 0.9626j, 0.3180 - 0.8893j, 0.7747 + 0.6624j, 0.1689 + 0.2231j, 0.4786 - 0.7017j, -0.9210 - 0.4414j, -0.3065 - 0.8494j, 0.7803 - 0.2071j, 0.4267 + 0.0326j, 0.0079 - 0.9200j, -1.0944 - 0.3790j, 0.1958 - 0.4683j, 0.4694 - 0.1195j, -0.1799 + 1.2853j, 0.9539 - 0.0328j, 0.5000 - 0.5000j, 0.2953 + 0.7868j, -0.4577 + 0.3144j, -1.0501 + 0.5218j, 0.6577 + 0.7389j, 0.5565 + 0.1130j, -0.4825 + 0.6503j, -0.4516 - 0.1744j, -0.2803 - 1.2071j, -0.9751 - 0.1325j, -1.0186 - 0.1640j, 0.6006 - 0.5923j, -0.0224 + 0.4302j, -0.7351 + 0.9210j, 0.7337 + 0.8470j, 0.0983 + 0.7808j,-1.2500, 0.0983 - 0.7808j, 0.7337 - 0.8470j, -0.7351 - 0.9210j, -0.0224 - 0.4302j, 0.6006 + 0.5923j, -1.0186 + 0.1640j, -0.9751 + 0.1325j, -0.2803 + 1.2071j, -0.4516 + 0.1744j, -0.4825 - 0.6503j, 0.5565 - 0.1130j, 0.6577 - 0.7389j, -1.0501 - 0.5218j, -0.4577 - 0.3144j, 0.2953 - 0.7868j, 0.5000 + 0.5000j, 0.9539 + 0.0328j, -0.1799 - 1.2853j, 0.4694 + 0.1195j, 0.1958 + 0.4683j, -1.0944 + 0.3790j, 0.0079 + 0.9200j,  0.4267 - 0.0326j, 0.7803 + 0.2071j, -0.3065 + 0.8494j, -0.9210 + 0.4414j, 0.4786 + 0.7017j, 0.1689 - 0.2231j, 0.7747 - 0.6624j, 0.3180 + 0.8893j, -0.0410 + 0.9626j)
gap_sample = (0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j,0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j,0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j,0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j,0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j,0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j,0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j, 0+0j)


class my_top_block(gr.top_block):
    def __init__(self, options):
        gr.top_block.__init__(self)
        
        self._fft_length     = 64
        self._cp_length      = 16
        self._symbol_length  = self._fft_length + self._cp_length
  
        N_sym = 25
        ofdm_preamble= [list(fft_preamble)]
        #print len(fft_preamble)
        gap = [list(gap_sample)]

        win = []
               
        inchr= chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00)
        inchr= inchr + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00)
        inchr= inchr + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00) + chr(0x00)       
        a = map(ord, chr(0))

        self.source = gr.file_source(gr.sizeof_gr_complex * self._symbol_length, options.from_file)
        self.vector_source = gr.vector_source_b(a,False,1)
        
        self.preamble = gr_ieee802_11.ofdm_preamble_insert(self._symbol_length, N_sym, ofdm_preamble)
        self.zerogap  = gr_ieee802_11.ofdm_zerogap_insert(self._symbol_length, N_sym, gap)
        self.sink = gr.file_sink(gr.sizeof_gr_complex * self._symbol_length, options.to_file)
        
        self.connect(self.source,(self.preamble, 0))
        self.connect(self.vector_source, (self.preamble, 1))
        self.connect((self.preamble,1), (self.zerogap, 1))
        self.connect(self.preamble,self.zerogap,self.sink)    
        #self.connect(self.ifft, gr.file_sink(gr.sizeof_gr_complex * self._fft_length, "ofdm_ifft_test.dat"))
        self.connect(self.preamble, gr.file_sink(gr.sizeof_gr_complex * self._symbol_length, "ofdm_preamble_test_3.6.4.dat"))
        



def main():    
    parser = OptionParser(option_class=eng_option, conflict_handler="resolve")
    parser.add_option("","--from-file", default="ofdm_scale_er.dat",
                      help="use intput file for packet contents")
    parser.add_option("","--to-file", default="ofdm_zerogap_test_3.6.4.dat",
                      help="Output file for modulated samples")
    (options, args) = parser.parse_args ()
    tb = my_top_block(options)
    tb.start()
    
    
    tb.wait()

if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        pass

        